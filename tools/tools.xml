<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="./ant2html.xsl"?>
<!--
   - Copyright (c) 2009-2010 Mark Birbeck
   -
   - Licensed under the Apache License, Version 2.0 (the "License");
   - you may not use this file except in compliance with the License.
   - You may obtain a copy of the License at
   -
   -  http://www.apache.org/licenses/LICENSE-2.0
   -
   - Unless required by applicable law or agreed to in writing, software
   - distributed under the License is distributed on an "AS IS" BASIS,
   - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   - See the License for the specific language governing permissions and
   - limitations under the License.
   -->
<project name="backplanejs-tools" default="help" basedir=".">
	<description>
		Ant project for the backplanejs tools.
	</description>
	<dirname property="backplanejs.tools.base.dir" file="${ant.file.backplanejs-tools}" />

	<!--
		Automatically load property files for the host application.
	-->
	<property file="my.ant.properties" />
	<property file="ant.properties" />
	<property file="drupal.ant.properties" />

	<!--
		These properties may have been set in the host application property files.
	-->
	<property name="product.name" value="my-product" />
	<property name="project.name" value="my-project" />
	<filter token="project.name" value="${project.name}"/>
	<property name="version.number" value="SNAPSHOT" />
	<filter token="version.number" value="${version.number}"/>

	<property name="platform.name" value="some-platform" />
	<property name="platform.version" value="SNAPSHOT" />

	<property name="dist.package.name" value="${project.name}" />
	<property name="package.name" value="${project.name}-${version.number}-${platform.name}-${platform.version}" />

	<property name="build.dir" location="build" />
	<property name="src.dir" location="${build.dir}/src" />

	<property name="target.dir" location="target" />
	<property name="deploy.dir" location="${target.dir}/deploy" />
	<property name="output.dir" location="${target.dir}/output" />
	<filter token="output.dir" value="${output.dir}"/>
	<property name="package.dir" location="${output.dir}/packages/${package.name}" />
	<property name="reports.dir" location="${target.dir}/reports" />
	<property name="site.dir" location="${target.dir}/site" />
	<property name="site.docs.dir" location="${site.dir}/docs" />
	<property name="tmp.dir" location="${target.dir}/tmp" />
	<property name="unit-tests.dir" location="${target.dir}/unit-tests" />
	<filter token="unit-tests.dir" value="${unit-tests.dir}"/>
	<property name="tdd.dir" location="${xforms.dir}/integration-tests" />
	<filter token="tdd.dir" value="${tdd.dir}"/>

	<property name="site.docs.project.url" value="http://example.com" />
	<!--
		End of properties.
	-->

	<!--
		Now load our tools.
	-->
	<import file="${backplanejs.tools.base.dir}/GoogleAppEngine/gae.xml" />
	<import file="${backplanejs.tools.base.dir}/selenium-rc/selenium-rc.xml" />
	<import file="${backplanejs.tools.base.dir}/yuitest-selenium/yuitest-selenium.xml" />

	<path id="ant.tasks.classpath">
		<fileset dir="${backplanejs.tools.base.dir}">
			<include name="ant-apache-bsf-1.7.1.jar" />
			<include name="ant-googlecode-0.0.2.jar" />
			<include name="bsf.jar" />
			<include name="commons-logging-1.1.1.jar" />
			<include name="yuicompressor-2.4.2.jar" />
		</fileset>
	</path>

	<scriptdef
		name="jslint"
		src="${backplanejs.tools.base.dir}/fulljslint-for-ant.js" language="javascript"
		classpathref="ant.tasks.classpath"
	>
		<attribute name="options" />
		<element name="fileset" type="fileset" />
	</scriptdef>

	<taskdef
		name="gcupload"
		classname="net.bluecow.googlecode.ant.GoogleCodeUploadTask"
		classpathref="ant.tasks.classpath"
	/>

	<!--
		This is a bit of a hack to work around Windows problems. There may
		be a better way to do this.
	-->
	<condition property="sprocketize.app.name" value="sprocketize.bat" else="sprocketize">
		<os family="windows" />
	</condition>

	<condition property="on.windows">
		<os family="windows" />
	</condition>

	<!--
		Phases
	-->
	<target name="help">
		<echo>See http://code.google.com/p/backplanejs/wiki/UsingTools</echo>
	</target>

	<target name="generate-sources" description="Copy the source files into the correct location." />

	<target name="generate-resources" description="Copy the resource files into the correct location." />

	<target name="compile" depends="initialize" description="Create combined JS and CSS files from sources.">
		<antcall target="generate-sources" />
		<antcall target="generate-resources" />

		<!--
			Created a combined JS file.
		-->
		<exec executable="${sprocketize.app.name}" output="${output.dir}/${product.name}.js" failonerror="true" logError="true">
			<arg value="-I" />
			<arg value="." />
			<arg value="-I" />
			<arg value="build" />
			<arg value="-I" />
			<arg value="third-party" />
			<arg value="-I" />
			<arg value="third-party/uxf/src" />
			<arg value="-I" />
			<arg value="third-party/uxf/src/lib" />
			<arg value="-I" />
			<arg value="third-party/uxf/src/lib/backplane" />
			<arg value="copyright.txt" />
			<arg value="${build.dir}/platform-${platform.name}.js" />
			<arg value="${build.dir}/platform-ui-${platform.name}.js" />
			<arg value="${build.dir}/${product.name}.js" />
			<arg value="-a${output.dir}/assets" />
		</exec>

		<!--
			Created a combined CSS file.
		-->
		<concat destfile="${output.dir}/assets/${product.name}.css" force="no" eol="crlf">
			<fileset dir="${output.dir}/assets">
				<include name="**/*.css" />
				<exclude name="lens/*.css" />
				<exclude name="${product.name}.css" />
			</fileset>
		</concat>
	</target>

	<target name="test" depends="initialize" description="Run tests.">
		<antcall target="compile" />
		<antcall target="test-compile" />
		<antcall target="test-ut" />
	</target>

	<!--
		P A C K A G E
		=============
	-->
	<target
		name="prepare-package"
		description="Perform any operations necessary to prepare a package before the actual packaging."
	>
		<copy todir="${package.dir}" failonerror="true">
			<fileset dir="${src.dir}" includes="copyright.txt" />
			<fileset dir="${output.dir}" />
		</copy>
	</target>

	<target
		name="package"
		description="Take the compiled code and package it in its distributable format."
	>
		<antcall target="compile" />
		<antcall target="prepare-package" />

		<mkdir dir="${deploy.dir}" />

		<zip destfile="${deploy.dir}/${package.name}.zip">
			<fileset dir="${package.dir}">
				<include name="**/*" />
			</fileset>
		</zip>
	</target>

	<target name="integration-test" depends="initialize, package" description="Test that the package deploys correctly.">
	</target>

	<target name="deploy" depends="initialize, package" description="Deploy the package.">
		<antcall target="-gcupload" />
	</target>

	<!--
		Goals
	-->
	<target name="validate">
		<fail unless="build.dir" message="Please set a value for 'build.dir'." />
		<fail unless="target.dir" message="Please set a value for 'target.dir'." />
	</target>

	<target name="initialize" depends="validate" description="Initialize the build state.">
		<mkdir dir="${target.dir}" />
	</target>

	<target name="clean" description="Remove the target directory ready for a clean build.">
		<delete dir="${target.dir}" />
	</target>

	<target name="test-compile" depends="initialize">
		<description>
			Create the unit test files, by concatenating the individual
			unit tests.
		</description>

		<!--
			YUI Unit Test Runner
		-->
		<concat destfile="${unit-tests.dir}/unit-test-runner.js" force="no" eol="crlf">
			<fileset dir="${src.dir}/third-party/yui">
				<include name="logger.js" />
				<include name="yuitest.js" />
			</fileset>
			<fileset dir="${build.dir}/test">
				<include name="unit-test-runner.js" />
			</fileset>
		</concat>

		<!--
			Backplane
		-->
		<concat destfile="${unit-tests.dir}/backplane/unit-tests.js" force="no" eol="crlf">
			<fileset dir="${src.dir}/third-party/uxf/src/lib/backplane/_unit-tests">
				<include name="**/*.js" />
			</fileset>
		</concat>
		<copy file="${build.dir}/test/unit.html" tofile="${unit-tests.dir}/backplane/main.html" failonerror="true" />

		<!--
			Knowledgebase
		-->
		<concat destfile="${unit-tests.dir}/kb/unit-tests.js" force="no" eol="crlf">
			<fileset dir="${src.dir}/kb/_unit-tests">
				<include name="**/*.js" />
			</fileset>
		</concat>
		<copy file="${build.dir}/test/unit.html" tofile="${unit-tests.dir}/kb/main.html" failonerror="true" />

		<!--
			RDFa
		-->
		<concat destfile="${unit-tests.dir}/rdfa/unit-tests.js" force="no" eol="crlf">
			<fileset dir="${src.dir}/rdfa/_unit-tests">
				<include name="**/*.js" />
			</fileset>
		</concat>
		<copy file="${build.dir}/test/unit.html" tofile="${unit-tests.dir}/rdfa/main.html" failonerror="true" />

		<!--
			XForms
		-->
		<concat destfile="${unit-tests.dir}/xforms/unit-tests.js" force="no" eol="crlf">
			<fileset dir="${src.dir}/third-party/uxf/unit-tests">
				<include name="**/*.js" />
				<exclude name="unit-test-loader.js" />
			</fileset>
			<fileset dir="${src.dir}/third-party/uxf/src/lib/functions">
				<include name="**/ut-*.js" />
			</fileset>
		</concat>
		<copy file="${build.dir}/test/unit.html" tofile="${unit-tests.dir}/xforms/main.html" failonerror="true" />
	</target>

	<target name="test-ut" description="Run unit-tests.">
		<parallel>
			<daemons>
				<antcall target="start-selenium-rc" />
			</daemons>

			<sequential>
				<waitfor>
					<and>
						<socket server="${selenium-rc.host}" port="${selenium-rc.port}" />
					</and>
				</waitfor>
				<copy todir="${unit-tests.dir}" failonerror="true" filtering="true">
					<fileset dir="${build.dir}/test" includes="test-list.xml"/>
				</copy>
				<antcall target="run-yuitest-selenium">
					<param name="test.list" value="${unit-tests.dir}/test-list.xml"/>
				</antcall>
			</sequential>
		</parallel>
	</target>

	<!--
		S I T E
		=======
	-->
	<target name="pre-site" description="Executes processes needed prior to the actual project site generation.">
		<echo>
The target 'pre-site' has not been set. You need to define this
in your own build.xml so that backplanejs knows which files to
document.
		</echo>
		<fail />
	</target>

	<target
		name="site"
		depends="initialize, pre-site, -create-docs, post-site, backplanejs-tools.post-site"
		description="Generates the project's site documentation."
	/>

	<target
		name="post-site"
		description="Executes processes needed to finalize the site generation, and to prepare for site deployment."
	>
		<copy todir="${site.dir}" failonerror="true">
			<fileset dir="${tmp.dir}/site-out" />
		</copy>

		<copy todir="${site.dir}" failonerror="true" overwrite="true" filtering="true">
			<fileset dir="${backplanejs.tools.base.dir}/GoogleAppEngine" includes="app.yaml" />
		</copy>
	</target>

	<target
		name="site-deploy"
		depends="site"
		description="Deploys the generated site documentation to the specified web server."
	>
		<fail unless="gae.username" message="Missing property 'gae.username' from file 'my.ant.properties'." />
		<fail unless="gae.password" message="Missing property 'gae.password' from file 'my.ant.properties'." />

		<antcall target="-site-deploy-windows" />
		<antcall target="-site-deploy-non-windows" />
	</target>

	<!--
		H E L P E R   T A S K S
		=======================
	-->
	<target name="-create-docs" description="Create the project's site documentation.">
		<exec executable="python" failonerror="true">
			<arg value="${backplanejs.tools.base.dir}/yuidoc/bin/yuidoc.py" />
			<arg value="${tmp.dir}/site-in/docs" />
			<arg value="-p" />
			<arg value="${tmp.dir}/tmpdocs" />
			<arg value="-o" />
			<arg value="${tmp.dir}/site-out/docs" />
			<arg value="-t" />
			<arg value="${backplanejs.tools.base.dir}/yuidoc/template" />
			<arg value="-m" />
			<arg value="${project.name}" />
			<arg value="-Y" />
			<arg value="${platform.version}" />
			<arg value="-v" />
			<arg value="${version.number}" />
			<arg value="-u" />
			<arg value="${site.docs.project.url}" />
		</exec>
	</target>

	<!--
		Annoying to have to do this, but on Windows the @inputstring value doesn't
		seem to get passed in when running a batch file. (And Windows doesn't
		understand @executable="appcfg.py" in the same way that Unix-like platforms
		do.)
	-->
	<target name="-site-deploy-windows" if="on.windows">
		<exec executable="python" failonerror="true" inputstring="${gae.password}">
			<arg value="${gae.windows.install.dir}/appcfg.py" />
			<arg line="--passin -e ${gae.username} update ${site.dir}/" />
		</exec>
	</target>

	<target name="-site-deploy-non-windows" unless="on.windows">
		<exec executable="appcfg.py" failonerror="true" inputstring="${gae.password}">
			<arg line="--passin -e ${gae.username} update ${site.dir}/" />
		</exec>
	</target>
</project>
